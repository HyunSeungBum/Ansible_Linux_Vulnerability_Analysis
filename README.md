# ISMS 세팅을 위한 Ansible

이 문서는 ISMS 심사를 위해서 OS 에 대한 설정을 Ansible 로 작성한 것입니다.

대부분 ISMS 심사를 위해 OS 를 세팅할 때에 수동으로 하는데 Ansible 을 통해서 자동화 하고자 하는데 목적이 있습니다.

기본적으로 RedHat 8.2 를 기반으로 하며, Minimal Installation 상태의 OS 다. 설치시에 Minimal 이 아닌 다른 추가적인 패키지 그룹이나 선택적 패키지 설치를 하였을 경우 이 Ansible 적용을 조심해야 한다. 

## Ansible 환경

Ansible 을 운영하는 환경은 RedHat 계열에 OS 에서 진행 했습니다. 확장성을 위해서 OS 를 체크해 적용되도록 작성했습니다.

모든 OS 는 최소설치를 전제로 합니다. 

다음으로 사용한 Ansible 의 버전은 다음과 같습니다.

https://blog.naver.com/oxcow119/222442691736

```sh
]$ ansible --version
ansible [core 2.11.6] 
  config file = /home/systemv/.ansible/ansible.cfg
  configured module search path = ['/home/systemv/.ansible/library']
  ansible python module location = /home/systemv/.python3/lib64/python3.9/site-packages/ansible
  ansible collection location = /home/systemv/.ansible/collections:/usr/share/ansible/collections
  executable location = /home/systemv/.python3/bin/ansible
  python version = 3.9.2 (default, May 20 2021, 01:29:22) [GCC 8.4.1 20200928 (Red Hat 8.4.1-1.0.1)]
  jinja version = 3.0.2
  libyaml = True
```

python3 버전을 기반으로 Ansible 을 설치했다는 것을 알수 있습니다.

## 초기 세팅

Ansible 을 세팅해야 합니다. 이는 Ansible 문서를 읽어보면 잘 나옵니다.

무엇보다 Ansible 을 운영하는 서버를 위해서 다음과 같은 패키지 설치를 필요로 합니다.

```sh
# "msg": "to use the 'ssh' connection type with passwords, you must install the sshpass program"
]$ dnf install sshpass
```

## 시스템 기본 설정(Role: init_base_system)

시스템 기본 설정은 비활성화할 서비스, 불필요한 패키지 제거, 선별적 패키지 최신판 업데이트를 포함 합니다.

이 Role 은 Minimal 설치 이후에 딱 한번만 실행해야 합니다. 많은 보안 소프트웨어를 설치하게 되는데, 예를들어 Kernel 에 의존적인 경우가 존재합니다. 이 Role 을 운영중에 여러번 실행할 경우에 Kernel 버전이 변경되면서 보안 소프트웨어가 작동되지 않을 가능성이 있습니다.

### 비활성화 서비스

비활성화 서비스는 다음과 같습니다.

* firewalld
* SELinux

SELinux 의 경우에 강력한 보안을 제공하지만, 프로젝트마다 사용여부는 제각각 입니다. 

### 불필요한 패키지 제거

Packagekit 는 YUM/DNF 를 이용한 패키지 자동 업데이트를 지원합니다. 운영중인 서버에서 패키지 자동 업데이트는 예기치 못한 장애를 발생시킬 가능성이 큼으로 이를 제거함으로써 패키지 자동 업데이트를 비활성화 하도록 합니다. 

* Packagekit*

### 선별적 패키지 최신판 업데이트

보안성을 높이기 위해서 패키지를 최신으로 유지할 필요가 있습니다. RedHat Distro 는 Security 패키지 그룹을 통해서 보안 업데이트를 손쉽게 할 수 있지만, 되도록 Security 패키지 그룹을 통한 업데이트를 하세요, 이를 사용하지 않고 선별적으로 패키지를 업데이트를 합니다.  

최신판으로 업데이트한 패키지 목록은 다음과 같습니다.

1. openssl
2. openssl-pkcs11
3. openssh-server
4. openssh-clients
5. openssh
6. sudo
7. ncurses-libs
8. pam
9. passwd
10. pcre2
11. pcre
12. readline
13. shadow-utils
14. kernel
15. systemd
16. systemd-libs
17. systemd-pam
18. systemd-udev
19. zlib
20. xz
21. filesystem
22. unzip
23. xfsprogs

## 불필요한 시스템 그룹, 계정 제거(Role: init_account)

Minimal 설치를 하였다 하더라도 불필요한 시스템 그룹, 계정이 있습니다. 제거한 시스템 그룹과 계정은 다음과 같습니다.

* 시스템 그룹
  1. floppy
  2. games
  3. cdrom
  4. video
  5. tape
  6. ftp
  7. audio
  8. kvm
  9. render
* 시스템 사용자
  1. games
  2. ftp

## SSH 서버 설정(Role: init_sshd_security)

SSH 서버 작업은 원격으로 진행해서는 안됩니다. 이 설정은 Ansible 이 아니라 직접 해줘야 합니다.

SSH 서버의 설정은 보통 /etc/ssh/sshd_config 에 있습니다.

### Port 변경

기본 포트인 22 는 너무나 잘 알려져 있어서 공격 대상이 됩니다. 기본 포트를 변경하는걸 강력히 추천합니다.

```ini
Port 40
```

### SSH 패스워드 없이 접속 설정(Public Key 사용자에 한함)

SSH 접속을 하는 방법에는 패스워드 없이 할 수 있는데, 보안적인 측면에서 이 방법을 권장 합니다. 하지만 많은 현장에서는 패스워드를 설정해서 접속을 하고 있습니다. 따라서 이 설정은 접속 방법에 따라서 적용할지 말지 결정을 한 후에 적용하기 권합니다. **패스워드 접속 방법을 선택했다면 이 방법을 적용해서는 안됩니다.**

패스워드 없이 접속하기 위한 SSH 서버 설정은 다음과 같습니다.

```ini
KbdInteractiveAuthentication no
PasswordAuthentication no
PubkeyAuthentication yes
```

패스워드 없이 접속을 허용하면 또 다른 방법으로 접속할 수 있도록 **PubkeyAuthentication yes** 를 통해 공개키 접속을 활성해 줍니다.

### SSH 패스워드 접속 설정

앞의 Public Key 접속 방법을 사용할 수 없을 경우에 패스워드 접속 설정을 해야 합니다.

```ini
KbdInteractiveAuthentication yes
PasswordAuthentication yes
PubkeyAuthentication no
```

### 패스워드 없는 사용자 접속 거부

시스템 관리자는 종종 시스템에 사용자를 생성할때 패스워드 설정을 잊곤 합니다. 이런 경우에 패스워드 기반 SSH 접속을 할때에 패스워드를 입력하지 않아도 접속이 됩니다.

빈 패스워드 접속을 차단해야 합니다. 

```ini
PermitEmptyPasswords no
```

### 루트(ROOT) 사용자 로그인 거부

시스템의 최고 사용자인 루트 사용자 로그인을 거부 합니다.

```ini
PermitRootLogin no
DenyUsers root
```

### SSH Protocol 2 사용

최신의 리눅스 배포판을 사용할 경우에 SSH 의 Protocol 버전은 2 입니다. 하지만 여전히 낮은 배포판을 사용할 경우에 버전 1 을 사용합니다. 확실히 하기 위해서 버전 2만 사용하도록 강제합니다.

```ini
Protocol 2
```

### idle timeout

SSH 를 접속한 후에 사용자가 아무것도 하지 않으면 idle 상태가 됩니다. 이 상태가 되면 SSH 는 내부적으로 시간을 재는데 특정 시간이 지나면 자동으로 접속을 차단 합니다.

```ini
ClientAliveInterval 120
ClientAliveCountMax 2
```

**ClientAliveCountMax** 는 idle 상태 체크를 몇번할 것인가 하는 설정입니다. 위 설정은 120 초 시간마다 idle 인지를 체크하고 그것을 2번 한다는 설정입니다. 결국 240 초가 지나는 동안 사용자가 아무것도 하지 않는다면 자동으로 접속이 해제 될 겁니다.

### 로그인 하지 않은 사용자 접속 해제

로그인 하지 않은 사용자에 대해 접속을 해제 합니다. 0 을 설정하면 시간 제한이 없습니다.

```ini
LoginGraceTime 30
```

### 최대 인증 시도 횟수

한 커넥션 당 최대 인증 시도 횟수 입니다. 기본값 6 입니다.

```ini
MaxAuthTries 3
```

### 최대 연결 세션 수

네트워크 커넥션 당 허용된 Shell, Login, subsystem(sftp) 세션 개수를 지정 합니다. 기본값 10 입니다.

```ini
MaxSessions 5
```

### X11Forwarding 비활성화

대부분의 서버들은 X11 GUI 를 설치하지 않습니다. 사용하지 않는 옵션임으로 no 로 설정 합니다.

```ini
X11Forwarding no
```

### 모든 포트 포워딩(Port Forwarding) 비활성화

모든 포트 포워딩을 비활성화 합니다. 이 옵션은 X11, ssh-agent, TCP 그리고 StreamLocal 등 모든 형태의 포워딩을 비활성화 합니다.

```ini
DisableForwarding yes
```

### 지난번 로그인 기록 안 보여주기

로그인시 지난번 로그인 기록을 보여주지 않게 설정 합니다.

```ini
PrintLastLog no
```

### SSH 접속 로깅

SSH 접속에 대한 로깅은 syslog 를 기반으로 하고 접속 로그 레벨은 VERBOSE 로 설정 합니다.

```ini
SyslogFacility AUTHPRIV
LogLevel VERBOSE
```

### SFTP 비활성화

주석처리로 SFTP 서버 비활성화 해줍니다. 

## AWS Cloud 패키지 설치.

AWS Cloud 에 실행되는 RedHat 의 경우에 필요한 퍀키지를 설치 합니다.

### EFS-Utils

AWS EFS 서비스를 위한 패키지 입니다. AWS EFS 서비스를 사용하기 위해 반드시 설치해야 하는 패키지는 아니지만, nfs client 리눅스 패키지 설치로 이용 가능, IAM 정책 적용을 지원합니다.

### CloudWatch 

AWS CloudWatch 에 커스텀 메트릭(Custom Metric) 수집을 위해 설치해야 합니다. 대표적인 커스텀 메트릭으로 Linux 시스템의 Memory 사용량 입니다. 

설정한 커스텀 메트릭은 다음과 같습니다.

1. Memory Usage