# ISMS 세팅을 위한 Ansible

이 문서는 ISMS 심사를 위해서 OS 에 대한 설정을 Ansible 로 작성한 것입니다.

대부분 ISMS 심사를 위해 OS 를 세팅할 때에 수동으로 하는데 Ansible 을 통해서 자동화 하고자 하는데 목적이 있습니다.

## Ansible 환경

Ansible 을 운영하는 환경은 RedHat 계열에 OS 에서 진행 했습니다. 확장성을 위해서 OS 를 체크해 적용되도록 작성했습니다.

모든 OS 는 최소설치를 전제로 합니다. 

다음으로 사용한 Ansible 의 버전은 다음과 같습니다.

https://blog.naver.com/oxcow119/222442691736

```sh
]$ ansible --version
ansible [core 2.11.6] 
  config file = /home/systemv/.ansible/ansible.cfg
  configured module search path = ['/home/systemv/.ansible/library']
  ansible python module location = /home/systemv/.python3/lib64/python3.9/site-packages/ansible
  ansible collection location = /home/systemv/.ansible/collections:/usr/share/ansible/collections
  executable location = /home/systemv/.python3/bin/ansible
  python version = 3.9.2 (default, May 20 2021, 01:29:22) [GCC 8.4.1 20200928 (Red Hat 8.4.1-1.0.1)]
  jinja version = 3.0.2
  libyaml = True
```

python3 버전을 기반으로 Ansible 을 설치했다는 것을 알수 있습니다.

## 초기 세팅

Ansible 을 세팅해야 합니다. 이는 Ansible 문서를 읽어보면 잘 나옵니다.

무엇보다 Ansible 을 운영하는 서버를 위해서 다음과 같은 패키지 설치를 필요로 합니다.

```sh
# "msg": "to use the 'ssh' connection type with passwords, you must install the sshpass program"
]$ dnf install sshpass
```

## SSH 서버 설정

SSH 서버 작업은 원격으로 진행해서는 안됩니다. 이 설정은 Ansible 이 아니라 직접 해줘야 합니다.

SSH 서버의 설정은 보통 /etc/ssh/sshd_config 에 있습니다.

### Port 변경

기본 포트인 22 는 너무나 잘 알려져 있어서 공격 대상이 됩니다. 기본 포트를 변경하는걸 강력히 추천합니다.

```ini
Port 40
```

### SSH 패스워드 없이 접속 설정(Public Key 사용자에 한함)

SSH 접속을 하는 방법에는 패스워드 없이 할 수 있는데, 보안적인 측면에서 이 방법을 권장 합니다. 하지만 많은 현장에서는 패스워드를 설정해서 접속을 하고 있습니다. 따라서 이 설정은 접속 방법에 따라서 적용할지 말지 결정을 한 후에 적용하기 권합니다. **패스워드 접속 방법을 선택했다면 이 방법을 적용해서는 안됩니다.**

패스워드 없이 접속하기 위한 SSH 서버 설정은 다음과 같습니다.

```ini
KbdInteractiveAuthentication no
PasswordAuthentication no
PubkeyAuthentication yes
```

패스워드 없이 접속을 허용하면 또 다른 방법으로 접속할 수 있도록 **PubkeyAuthentication yes** 를 통해 공개키 접속을 활성해 줍니다.

### SSH 패스워드 접속 설정

앞의 Public Key 접속 방법을 사용할 수 없을 경우에 패스워드 접속 설정을 해야 합니다.

```ini
KbdInteractiveAuthentication yes
PasswordAuthentication yes
PubkeyAuthentication no
```

### 패스워드 없는 사용자 접속 거부

시스템 관리자는 종종 시스템에 사용자를 생성할때 패스워드 설정을 잊곤 합니다. 이런 경우에 패스워드 기반 SSH 접속을 할때에 패스워드를 입력하지 않아도 접속이 됩니다.

빈 패스워드 접속을 차단해야 합니다. 

```ini
PermitEmptyPasswords no
```

### 루트(ROOT) 사용자 로그인 거부

시스템의 최고 사용자인 루트 사용자 로그인을 거부 합니다.

```ini
PermitRootLogin no
DenyUsers root
```

### SSH Protocol 2 사용

최신의 리눅스 배포판을 사용할 경우에 SSH 의 Protocol 버전은 2 입니다. 하지만 여전히 낮은 배포판을 사용할 경우에 버전 1 을 사용합니다. 확실히 하기 위해서 버전 2만 사용하도록 강제합니다.

```ini
Protocol 2
```

### idle timeout

SSH 를 접속한 후에 사용자가 아무것도 하지 않으면 idle 상태가 됩니다. 이 상태가 되면 SSH 는 내부적으로 시간을 재는데 특정 시간이 지나면 자동으로 접속을 차단 합니다.

```ini
ClientAliveInterval 120
ClientAliveCountMax 2
```

**ClientAliveCountMax** 는 idle 상태 체크를 몇번할 것인가 하는 설정입니다. 위 설정은 120 초 시간마다 idle 인지를 체크하고 그것을 2번 한다는 설정입니다. 결국 240 초가 지나는 동안 사용자가 아무것도 하지 않는다면 자동으로 접속이 해제 될 겁니다.

### 로그인 하지 않은 사용자 접속 해제

로그인 하지 않은 사용자에 대해 접속을 해제 합니다. 0 을 설정하면 시간 제한이 없습니다.

```ini
LoginGraceTime 30
```

### 최대 인증 시도 횟수

한 커넥션 당 최대 인증 시도 횟수 입니다. 기본값 6 입니다.

```ini
MaxAuthTries 3
```

### 최대 연결 세션 수

네트워크 커넥션 당 허용된 Shell, Login, subsystem(sftp) 세션 개수를 지정 합니다. 기본값 10 입니다.

```ini
MaxSessions 5
```

### X11Forwarding 비활성화

대부분의 서버들은 X11 GUI 를 설치하지 않습니다. 사용하지 않는 옵션임으로 no 로 설정 합니다.

```ini
X11Forwarding no
```

### 모든 포트 포워딩(Port Forwarding) 비활성화

모든 포트 포워딩을 비활성화 합니다. 이 옵션은 X11, ssh-agent, TCP 그리고 StreamLocal 등 모든 형태의 포워딩을 비활성화 합니다.

```ini
DisableForwarding yes
```


